<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Containers & Kubernetes - Iron Codex</title>
    <meta name="description" content="Comprehensive container security guide with 29 controls for Docker, Kubernetes hardening, and runtime protection">
</head>
<body data-page="guide">
    <main class="w3-container">
        <section class="guide-header">
            <nav class="breadcrumb">
                <a href="../guides.html">Guides</a> / <span>Containers & Kubernetes</span>
            </nav>
            <h1>Containers & Kubernetes</h1>
            <div class="guide-meta">
                <span class="meta-item">29 Controls</span>
                <span class="meta-item">Intermediate Level</span>
                <span class="meta-item">Last Updated: December 2024</span>
            </div>
            <p class="guide-intro">Docker and Kubernetes security hardening with runtime protection, image scanning, network policies, and orchestration security best practices.</p>
        </section>

        <section class="toc-section">
            <h2>Table of Contents</h2>
            <div class="w3-row">
                <div class="w3-col">
                    <ul class="toc-list">
                        <li><a href="#image-security">1. Image Security (8 controls)</a></li>
                        <li><a href="#runtime-security">2. Runtime Security (7 controls)</a></li>
                        <li><a href="#kubernetes-hardening">3. Kubernetes Hardening (6 controls)</a></li>
                        <li><a href="#network-policies">4. Network Policies (4 controls)</a></li>
                    </ul>
                </div>
                <div class="w3-col">
                    <ul class="toc-list">
                        <li><a href="#secrets-management">5. Secrets Management (2 controls)</a></li>
                        <li><a href="#monitoring">6. Monitoring & Logging (2 controls)</a></li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="image-security" class="control-section">
            <h2>1. Image Security (8 controls)</h2>
            <p class="section-intro">Secure container images through vulnerability scanning, minimal base images, and secure build practices.</p>

            <div class="w3-panel">
                <h3>Implement Container Image Scanning</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-medium">Medium Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Scan all container images for vulnerabilities before deployment using automated tools.</p>
                <div class="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Trivy scanning in CI/CD pipeline
name: Container Security Scan
on: [push, pull_request]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t myapp:${{ github.sha }} .
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: myapp:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '1'  # Fail build on HIGH/CRITICAL vulns
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

# Docker image scanning with Clair
version: '3'
services:
  clair:
    image: quay.io/coreos/clair:v2.1.6
    ports:
      - "6060:6060"
      - "6061:6061"
    depends_on:
      - postgres
    volumes:
      - ./clair-config.yaml:/config/config.yaml
    command: -config=/config/config.yaml

  postgres:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_DB: clair</pre></div>
                </div>
                <div class="validation">
                    <h4>Validation:</h4>
                    <ul>
                        <li>Verify scanning detects known vulnerabilities</li>
                        <li>Test CI/CD pipeline fails on critical vulnerabilities</li>
                        <li>Validate regular base image updates</li>
                        <li>Check scan result integration with security dashboards</li>
                    </ul>
                </div>
            </div>

            <div class="w3-panel">
                <h3>Use Minimal Base Images</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High Priority</span>
                    <span class="tag difficulty-low">Low Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Use distroless or minimal base images to reduce attack surface and vulnerabilities.</p>
                <div class="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Multi-stage Dockerfile with distroless final image
FROM golang:1.19-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o main .

# Final stage - distroless image
FROM gcr.io/distroless/static-debian11
WORKDIR /
COPY --from=builder /app/main /
USER nonroot:nonroot
ENTRYPOINT ["/main"]

# Alpine-based minimal image example
FROM alpine:3.18
RUN apk --no-cache add ca-certificates tzdata
RUN addgroup -g 1001 -S appuser && adduser -u 1001 -S appuser -G appuser
USER appuser
COPY --chown=appuser:appuser myapp /usr/local/bin/myapp
ENTRYPOINT ["/usr/local/bin/myapp"]

# Scratch image for static binaries
FROM scratch
COPY ca-certificates.crt /etc/ssl/certs/
COPY myapp /myapp
ENTRYPOINT ["/myapp"]</pre></div>
                </div>
                <div name="best-practices">
                    <h4>Best Practices:</h4>
                    <ul>
                        <li>Use official distroless images when possible</li>
                        <li>Remove package managers from final images</li>
                        <li>Don't include shells or debugging tools in production images</li>
                        <li>Regularly update base images</li>
                    </ul>
                </div>
            </div>

            <div class="w3-panel">
                <h3>Implement Image Signing and Verification</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High Priority</span>
                    <span class="tag difficulty-high">High Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Sign container images and verify signatures before deployment to ensure integrity.</p>
                <div name="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Docker Content Trust (Notary)
export DOCKER_CONTENT_TRUST=1
docker push myregistry.com/myapp:v1.0

# Cosign signing
cosign generate-key-pair
cosign sign --key cosign.key myregistry.com/myapp:v1.0

# Verify signature
cosign verify --key cosign.pub myregistry.com/myapp:v1.0

# Kubernetes admission controller for signature verification
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-image-signatures
spec:
  validationFailureAction: enforce
  background: false
  rules:
  - name: verify-signature
    match:
      any:
      - resources:
          kinds:
          - Pod
    verifyImages:
    - image: "myregistry.com/*"
      key: |-
        -----BEGIN PUBLIC KEY-----
        MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...
        -----END PUBLIC KEY-----</pre></div>
                </div>
            </div>

            <div class="control-summary">
                <h4>Additional Image Security Controls:</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>Secure Image Registry:</strong> Private registry with access controls and scanning
                    </div>
                    <div class="summary-item">
                        <strong>Image Immutability:</strong> Prevent image modifications after deployment
                    </div>
                    <div class="summary-item">
                        <strong>Build Security:</strong> Secure CI/CD pipelines and build environments
                    </div>
                    <div class="summary-item">
                        <strong>License Compliance:</strong> Track and manage software licenses in images
                    </div>
                    <div class="summary-item">
                        <strong>Secrets Scanning:</strong> Detect hardcoded secrets in images
                    </div>
                </div>
            </div>
        </section>

        <section id="runtime-security" class="control-section">
            <h2>2. Runtime Security (7 controls)</h2>
            <p class="section-intro">Secure container runtime with proper isolation, resource limits, and security contexts.</p>

            <div class="w3-panel">
                <h3>Implement Security Contexts</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-medium">Medium Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Configure proper security contexts to run containers with minimal privileges.</p>
                <div class="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Kubernetes Pod Security Context
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault
    seLinuxOptions:
      level: "s0:c123,c456"
  containers:
  - name: app
    image: myapp:latest
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 1000
      capabilities:
        drop:
        - ALL
        add:
        - NET_BIND_SERVICE
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
    volumeMounts:
    - name: tmp-volume
      mountPath: /tmp
  volumes:
  - name: tmp-volume
    emptyDir: {}</pre></div>
                </div>
            </div>

            <div class="w3-panel">
                <h3>Enable Runtime Protection</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High Priority</span>
                    <span class="tag difficulty-high">High Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Deploy runtime security tools to detect and prevent malicious activity.</p>
                <div class="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Falco runtime security rules
- rule: Container with Sensitive Mount
  desc: Detect container with sensitive host paths mounted
  condition: >
    spawned_process and container and
    (fd.name startswith /proc or
     fd.name startswith /var/run/docker.sock or
     fd.name startswith /var/run/crio.sock or
     fd.name startswith /run/containerd or
     fd.name startswith /var/lib/kubelet)
  output: >
    Container with sensitive mount started
    (user=%user.name command=%proc.cmdline
     container=%container.name image=%container.image.repository:%container.image.tag)
  priority: WARNING

# AppArmor profile for containers
#include <tunables/global>

profile docker-default flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  deny @{PROC}/* w,   # deny write for all files directly in /proc
  deny @{PROC}/{[^1-9],[^1-9][^0-9],[^1-9s][^0-9y][^0-9s],[^1-9][^0-9][^0-9][^0-9]*}/** w,
  deny @{PROC}/sys/[^k]** w,  # deny /proc/sys except /proc/sys/k*
  deny @{PROC}/sys/kernel/{?,??,[^s]***} w,  # deny everything except shm* in /proc/sys/kernel/
  deny @{PROC}/sysrq-trigger rwklx,
  deny @{PROC}/mem rwklx,
  deny @{PROC}/kmem rwklx,
  deny @{PROC}/kcore rwklx,
  deny mount,
  deny /sys/[^f]*/** wklx,
  deny /sys/f[^s]*/** wklx,
  deny /sys/fs/[^c]*/** wklx,
  deny /sys/fs/c[^g]*/** wklx,
  deny /sys/fs/cg[^r]*/** wklx,
  deny /sys/firmware/** rwklx,
  deny /sys/kernel/security/** rwklx,
}</pre></div>
                </div>
            </div>

            <div class="control-summary">
                <h4>Additional Runtime Security Controls:</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>Resource Limits:</strong> CPU, memory, and I/O constraints
                    </div>
                    <div class="summary-item">
                        <strong>Container Isolation:</strong> Proper namespace and cgroup configuration
                    </div>
                    <div class="summary-item">
                        <strong>Host Protection:</strong> Prevent container escape and host access
                    </div>
                    <div class="summary-item">
                        <strong>Process Monitoring:</strong> Track container process execution
                    </div>
                    <div class="summary-item">
                        <strong>File System Security:</strong> Read-only root filesystem and proper mounts
                    </div>
                </div>
            </div>
        </section>

        <section id="kubernetes-hardening" class="control-section">
            <h2>3. Kubernetes Hardening (6 controls)</h2>
            <p class="section-intro">Harden Kubernetes clusters with RBAC, admission controllers, and security policies.</p>

            <div class="w3-panel">
                <h3>Configure RBAC Properly</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-medium">Medium Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Implement least privilege RBAC with proper role separation.</p>
                <div class="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Service Account with minimal permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-service-account
  namespace: production

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: production
  name: app-role
rules:
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: app-role-binding
  namespace: production
subjects:
- kind: ServiceAccount
  name: app-service-account
  namespace: production
roleRef:
  kind: Role
  name: app-role
  apiGroup: rbac.authorization.k8s.io

# Pod using service account
apiVersion: v1
kind: Pod
metadata:
  name: secure-app
  namespace: production
spec:
  serviceAccountName: app-service-account
  automountServiceAccountToken: false  # Disable if not needed</pre></div>
                </div>
            </div>

            <div class="w3-panel">
                <h3>Implement Pod Security Standards</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High Priority</span>
                    <span class="tag difficulty-medium">Medium Difficulty</span>
                </div>
                <p><strong>Requirement:</strong> Use Pod Security Standards to enforce security policies at the namespace level.</p>
                <div class="implementation">
                    <h4>Implementation Example:</h4>
                    <div class="w3-example"><pre class="w3-code"># Namespace with Pod Security Standards
apiVersion: v1
kind: Namespace
metadata:
  name: secure-namespace
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

# OPA Gatekeeper ConstraintTemplate
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredsecuritycontext
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredSecurityContext
      validation:
        type: object
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredsecuritycontext
        
        violation[{"msg": msg}] {
          input.review.object.kind == "Pod"
          not input.review.object.spec.securityContext.runAsNonRoot
          msg := "Pod must run as non-root user"
        }
        
        violation[{"msg": msg}] {
          input.review.object.kind == "Pod"
          container := input.review.object.spec.containers[_]
          not container.securityContext.allowPrivilegeEscalation == false
          msg := "Containers must not allow privilege escalation"
        }</pre></div>
                </div>
            </div>

            <div class="control-summary">
                <h4>Additional Kubernetes Hardening Controls:</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>API Server Security:</strong> Secure API server configuration and access
                    </div>
                    <div class="summary-item">
                        <strong>etcd Security:</strong> Encrypt etcd data and secure communication
                    </div>
                    <div class="summary-item">
                        <strong>Node Security:</strong> Harden worker nodes and kubelet configuration
                    </div>
                    <div class="summary-item">
                        <strong>Admission Controllers:</strong> Custom admission controllers for policy enforcement
                    </div>
                </div>
            </div>
        </section>

        <section class="remaining-sections">
            <h2>Remaining Sections</h2>
            <div class="section-preview">
                <div class="preview-card" id="network-policies">
                    <h3>4. Network Policies (4 controls)</h3>
                    <p>Secure container networking with policies and segmentation.</p>
                    <ul class="preview-controls">
                        <li>Network Policy Implementation</li>
                        <li>Service Mesh Security</li>
                        <li>Ingress Security</li>
                        <li>Network Segmentation</li>
                    </ul>
                </div>

                <div class="preview-card" id="secrets-management">
                    <h3>5. Secrets Management (2 controls)</h3>
                    <p>Secure handling of sensitive data in containers.</p>
                    <ul class="preview-controls">
                        <li>Kubernetes Secrets Security</li>
                        <li>External Secrets Integration</li>
                    </ul>
                </div>

                <div class="preview-card" id="monitoring">
                    <h3>6. Monitoring & Logging (2 controls)</h3>
                    <p>Container security monitoring and audit logging.</p>
                    <ul class="preview-controls">
                        <li>Security Event Monitoring</li>
                        <li>Audit Log Analysis</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="guide-footer">
            <div class="footer-nav">
                <a href="../guides.html" class="btn btn-outline">← Back to Guides</a>
                <a href="#" onclick="downloadGuide()" class="btn btn-primary">Download PDF</a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Iron Codex. Open source cybersecurity education.</p>
            </div>
        </div>
    </footer>

    <script src="../assets/js/main.js"></script>
    <script>
        function downloadGuide() {
            alert('PDF download feature coming soon! For now, you can bookmark this page or print to PDF using your browser.');
        }

        document.querySelectorAll('.toc-list a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>

    <style>
        .guide-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .guide-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .breadcrumb {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: var(--accent);
        }

        .guide-header h1 {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .guide-meta {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            background: var(--glass);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .guide-intro {
            font-size: 1.2rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .toc-section {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
        }

        .toc-section h2 {
            color: var(--accent);
            margin-bottom: 1.5rem;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .toc-list {
            list-style: none;
        }

        .toc-list li {
            margin-bottom: 0.5rem;
        }

        .toc-list a {
            color: var(--text);
            text-decoration: none;
            padding: 0.5rem;
            display: block;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .toc-list a:hover {
            background: var(--glass);
            color: var(--accent);
        }

        .control-section {
            margin-bottom: 4rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .control-section h2 {
            color: var(--accent);
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .section-intro {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .control-card h3 {
            color: var(--accent);
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .control-tags {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tag {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-critical {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .priority-high {
            background: rgba(255, 167, 38, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .difficulty-low {
            background: rgba(46, 213, 115, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .difficulty-medium {
            background: rgba(255, 167, 38, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .difficulty-high {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .implementation,
        .validation,
        .best-practices,
        .security-notes {
            margin: 1.5rem 0;
        }

        .implementation h4,
        .validation h4,
        .best-practices h4,
        .security-notes h4 {
            color: var(--success);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        pre {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        code {
            color: var(--accent);
            font-family: 'Courier New', monospace;
        }

        .control-summary {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-item {
            background: var(--glass);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .remaining-sections {
            margin: 4rem 0;
        }

        .section-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .preview-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .preview-card h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .preview-controls {
            list-style: none;
            margin-top: 1rem;
        }

        .preview-controls li {
            color: var(--text-muted);
            padding: 0.3rem 0;
            font-size: 0.9rem;
        }

        .guide-footer {
            text-align: center;
            padding: 3rem 0;
            margin-top: 4rem;
            border-top: 2px solid var(--border);
        }

        .footer-nav {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .guide-header h1 {
                font-size: 2rem;
            }
            
            .guide-meta {
                flex-direction: column;
                gap: 1rem;
            }
            
            .toc-grid,
            .summary-grid,
            .section-preview {
                grid-template-columns: 1fr;
            }
            
            .footer-nav {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</body>
</html>