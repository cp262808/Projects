<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Security Expanded - Iron Codex</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <meta name="description" content="Comprehensive API security guide with 74 practical controls for REST, GraphQL, authentication, and more">
</head>
<body data-page="guide">
    <header class="header">
        <nav class="nav container">
            <a href="../index.html" class="logo">üõ°Ô∏è Iron Codex</a>
            <ul class="nav-menu">
                <li><a href="../index.html" class="nav-link">Home</a></li>
                <li><a href="../topics.html" class="nav-link">Topics</a></li>
                <li><a href="../guides.html" class="nav-link">Guides</a></li>
                <li><a href="../tools.html" class="nav-link">Tools</a></li>
                <li><a href="../about.html" class="nav-link">About</a></li>
            </ul>
            <div class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <main class="container guide-content">
        <!-- Guide Header -->
        <section class="guide-header">
            <nav class="breadcrumb">
                <a href="../guides.html">Guides</a> / <span>API Security Expanded</span>
            </nav>
            <h1>API Security Expanded</h1>
            <div class="guide-meta">
                <span class="meta-item">74 Controls</span>
                <span class="meta-item">Expert Level</span>
                <span class="meta-item">Last Updated: September 2025</span>
            </div>
            <p class="guide-intro">Complete API security framework covering REST, GraphQL, authentication, authorization, rate limiting, and API gateway configuration with practical implementation examples.</p>
        </section>

        <!-- Table of Contents -->
        <section class="toc-section">
            <h2>Table of Contents</h2>
            <div class="toc-grid">
                <div class="toc-column">
                    <ul class="toc-list">
                        <li><a href="#authentication">1. Authentication (12 controls)</a></li>
                        <li><a href="#authorization">2. Authorization (10 controls)</a></li>
                        <li><a href="#input-validation">3. Input Validation (14 controls)</a></li>
                        <li><a href="#rate-limiting">4. Rate Limiting (8 controls)</a></li>
                    </ul>
                </div>
                <div class="toc-column">
                    <ul class="toc-list">
                        <li><a href="#logging-monitoring">5. Logging & Monitoring (12 controls)</a></li>
                        <li><a href="#data-protection">6. Data Protection (9 controls)</a></li>
                        <li><a href="#api-gateway">7. API Gateway Security (5 controls)</a></li>
                        <li><a href="#graphql-security">8. GraphQL Security (4 controls)</a></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Authentication Section (12 Controls) -->
        <section id="authentication" class="control-section">
            <h2>1. Authentication (12 Controls)</h2>
            <p class="section-intro">Strong authentication mechanisms are the foundation of API security. These controls establish user identity and ensure only authenticated entities can access your APIs.</p>

            <!-- Control 1.1 -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">1.1 Multi-Factor Authentication (MFA)</h3>
                    <div class="control-tags">
                        <span class="tag priority-critical">Critical</span>
                        <span class="tag difficulty-medium">Medium</span>
                    </div>
                </div>
                
                <div class="control-content">
                    <p class="control-description">Implement multi-factor authentication for all API access, especially for privileged operations and sensitive data access.</p>
                    
                    <div class="implementation">
                        <h4>üîß Implementation</h4>
                        <pre><code>// OAuth 2.0 with PKCE + TOTP Example
const auth = {
    // Step 1: PKCE Challenge
    codeVerifier: generateCodeVerifier(),
    codeChallenge: generateCodeChallenge(codeVerifier),
    
    // Step 2: Request authorization with MFA requirement
    authUrl: `https://auth.example.com/oauth/authorize?` +
             `client_id=${clientId}&` +
             `redirect_uri=${redirectUri}&` +
             `code_challenge=${codeChallenge}&` +
             `code_challenge_method=S256&` +
             `scope=api:read api:write&` +
             `acr_values=mfa`,  // Require MFA
    
    // Step 3: Exchange code for token (includes MFA verification)
    async exchangeToken(authCode) {
        const response = await fetch('/oauth/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                grant_type: 'authorization_code',
                client_id: clientId,
                code: authCode,
                redirect_uri: redirectUri,
                code_verifier: this.codeVerifier
            })
        });
        return response.json();
    }
};</code></pre>
                    </div>

                    <div class="validation">
                        <h4>‚úÖ Validation</h4>
                        <ul>
                            <li>Verify MFA challenge completion before token issuance</li>
                            <li>Check token includes MFA claim (amr: ["mfa", "totp"])</li>
                            <li>Test MFA bypass attempts return 401 Unauthorized</li>
                            <li>Validate MFA requirement for sensitive operations</li>
                        </ul>
                    </div>

                    <div class="best-practices">
                        <h4>üìã Best Practices</h4>
                        <ul>
                            <li>Support multiple MFA methods (TOTP, SMS, hardware keys)</li>
                            <li>Implement adaptive MFA based on risk factors</li>
                            <li>Provide MFA recovery mechanisms</li>
                            <li>Monitor and alert on MFA failures</li>
                        </ul>
                    </div>

                    <div class="security-notes">
                        <h4>üîí Security Notes</h4>
                        <ul>
                            <li>SMS-based MFA is vulnerable to SIM swapping</li>
                            <li>Consider WebAuthn/FIDO2 for passwordless MFA</li>
                            <li>Implement rate limiting on MFA attempts</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Control 1.2 -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">1.2 JWT Token Validation</h3>
                    <div class="control-tags">
                        <span class="tag priority-critical">Critical</span>
                        <span class="tag difficulty-high">High</span>
                    </div>
                </div>
                
                <div class="control-content">
                    <p class="control-description">Properly validate JSON Web Tokens including signature verification, expiration, and claims validation.</p>
                    
                    <div class="implementation">
                        <h4>üîß Implementation</h4>
                        <pre><code>const jwt = require('jsonwebtoken');
const jwksClient = require('jwks-rsa');

// JWKS client for key rotation
const client = jwksClient({
    jwksUri: 'https://auth.example.com/.well-known/jwks.json',
    cache: true,
    cacheMaxAge: 86400000, // 24 hours
    rateLimit: true,
    jwksRequestsPerMinute: 5
});

function getKey(header, callback) {
    client.getSigningKey(header.kid, (err, key) => {
        const signingKey = key.publicKey || key.rsaPublicKey;
        callback(null, signingKey);
    });
}

// Middleware for JWT validation
function validateJWT(req, res, next) {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
        return res.status(401).json({ error: 'Missing token' });
    }

    jwt.verify(token, getKey, {
        audience: process.env.JWT_AUDIENCE,
        issuer: process.env.JWT_ISSUER,
        algorithms: ['RS256'],
        clockTolerance: 30, // 30 second clock skew tolerance
        maxAge: '1h' // Maximum token age
    }, (err, decoded) => {
        if (err) {
            return res.status(401).json({ 
                error: 'Invalid token',
                details: err.message 
            });
        }
        
        // Additional custom validations
        if (!decoded.sub || !decoded.scope) {
            return res.status(401).json({ error: 'Invalid token claims' });
        }
        
        req.user = decoded;
        next();
    });
}</code></pre>
                    </div>

                    <div class="validation">
                        <h4>‚úÖ Validation</h4>
                        <ul>
                            <li>Verify signature with correct public key</li>
                            <li>Check token expiration (exp claim)</li>
                            <li>Validate issuer (iss) and audience (aud) claims</li>
                            <li>Ensure algorithm is explicitly whitelisted</li>
                            <li>Test with tampered tokens to ensure rejection</li>
                        </ul>
                    </div>

                    <div class="best-practices">
                        <h4>üìã Best Practices</h4>
                        <ul>
                            <li>Use short-lived access tokens (15-60 minutes)</li>
                            <li>Implement token refresh mechanisms</li>
                            <li>Include necessary claims only (principle of least privilege)</li>
                            <li>Use secure key rotation practices</li>
                        </ul>
                    </div>

                    <div class="security-notes">
                        <h4>üîí Security Notes</h4>
                        <ul>
                            <li>Never accept "none" algorithm</li>
                            <li>Always validate the "alg" header parameter</li>
                            <li>Beware of key confusion attacks (RSA/HMAC)</li>
                            <li>Implement proper JWKS caching and rotation</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Control 1.3 -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">1.3 OAuth 2.0 PKCE Implementation</h3>
                    <div class="control-tags">
                        <span class="tag priority-high">High</span>
                        <span class="tag difficulty-medium">Medium</span>
                    </div>
                </div>
                
                <div class="control-content">
                    <p class="control-description">Implement Proof Key for Code Exchange (PKCE) to secure OAuth 2.0 authorization code flow against code interception attacks.</p>
                    
                    <div class="implementation">
                        <h4>üîß Implementation</h4>
                        <pre><code>// Client-side PKCE implementation
class PKCEAuth {
    constructor(clientId, redirectUri, authEndpoint, tokenEndpoint) {
        this.clientId = clientId;
        this.redirectUri = redirectUri;
        this.authEndpoint = authEndpoint;
        this.tokenEndpoint = tokenEndpoint;
    }

    // Generate code verifier (43-128 characters)
    generateCodeVerifier() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return btoa(String.fromCharCode(...array))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
    }

    // Generate code challenge
    async generateCodeChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode(...new Uint8Array(digest)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
    }

    // Start authorization flow
    async startAuth(scopes = ['read']) {
        this.codeVerifier = this.generateCodeVerifier();
        this.codeChallenge = await this.generateCodeChallenge(this.codeVerifier);
        this.state = crypto.randomUUID();

        const params = new URLSearchParams({
            response_type: 'code',
            client_id: this.clientId,
            redirect_uri: this.redirectUri,
            scope: scopes.join(' '),
            state: this.state,
            code_challenge: this.codeChallenge,
            code_challenge_method: 'S256'
        });

        window.location.href = `${this.authEndpoint}?${params}`;
    }

    // Exchange authorization code for tokens
    async exchangeCodeForTokens(code, state) {
        if (state !== this.state) {
            throw new Error('State mismatch - possible CSRF attack');
        }

        const response = await fetch(this.tokenEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                client_id: this.clientId,
                code: code,
                redirect_uri: this.redirectUri,
                code_verifier: this.codeVerifier
            })
        });

        if (!response.ok) {
            throw new Error(`Token exchange failed: ${response.status}`);
        }

        return response.json();
    }
}</code></pre>
                    </div>

                    <div class="validation">
                        <h4>‚úÖ Validation</h4>
                        <ul>
                            <li>Verify code verifier matches code challenge</li>
                            <li>Ensure code challenge method is S256</li>
                            <li>Validate state parameter to prevent CSRF</li>
                            <li>Test with invalid code verifier to ensure rejection</li>
                        </ul>
                    </div>

                    <div class="best-practices">
                        <h4>üìã Best Practices</h4>
                        <ul>
                            <li>Always use S256 challenge method (not plain)</li>
                            <li>Generate cryptographically secure random values</li>
                            <li>Store code verifier securely on client</li>
                            <li>Implement proper error handling</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Control 1.4 -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">1.4 API Key Management</h3>
                    <div class="control-tags">
                        <span class="tag priority-high">High</span>
                        <span class="tag difficulty-low">Low</span>
                    </div>
                </div>
                
                <div class="control-content">
                    <p class="control-description">Implement secure API key generation, distribution, rotation, and revocation mechanisms.</p>
                    
                    <div class="implementation">
                        <h4>üîß Implementation</h4>
                        <pre><code>// API Key Management System
const crypto = require('crypto');

class APIKeyManager {
    constructor(database) {
        this.db = database;
        this.keyPrefix = 'ak_'; // API key prefix for identification
    }

    // Generate secure API key
    generateAPIKey() {
        const randomBytes = crypto.randomBytes(32);
        const apiKey = this.keyPrefix + randomBytes.toString('base64url');
        return apiKey;
    }

    // Create API key with metadata
    async createAPIKey(userId, scopes, expiresIn = '1y') {
        const apiKey = this.generateAPIKey();
        const hashedKey = crypto.createHash('sha256').update(apiKey).digest('hex');
        
        const keyData = {
            id: crypto.randomUUID(),
            user_id: userId,
            key_hash: hashedKey,
            scopes: scopes,
            created_at: new Date(),
            expires_at: new Date(Date.now() + this.parseExpiry(expiresIn)),
            last_used: null,
            is_active: true
        };

        await this.db.apiKeys.insert(keyData);
        
        // Return the plain key only once
        return {
            id: keyData.id,
            key: apiKey, // Only returned during creation
            scopes: keyData.scopes,
            expires_at: keyData.expires_at
        };
    }

    // Validate API key
    async validateAPIKey(apiKey) {
        if (!apiKey || !apiKey.startsWith(this.keyPrefix)) {
            return null;
        }

        const hashedKey = crypto.createHash('sha256').update(apiKey).digest('hex');
        
        const keyRecord = await this.db.apiKeys.findOne({
            key_hash: hashedKey,
            is_active: true,
            expires_at: { $gt: new Date() }
        });

        if (keyRecord) {
            // Update last used timestamp
            await this.db.apiKeys.updateOne(
                { id: keyRecord.id },
                { $set: { last_used: new Date() } }
            );
        }

        return keyRecord;
    }

    // Middleware for API key authentication
    middleware() {
        return async (req, res, next) => {
            const apiKey = req.headers['x-api-key'] || 
                          req.headers['authorization']?.replace('Bearer ', '');

            if (!apiKey) {
                return res.status(401).json({ error: 'API key required' });
            }

            const keyRecord = await this.validateAPIKey(apiKey);
            
            if (!keyRecord) {
                return res.status(401).json({ error: 'Invalid API key' });
            }

            req.apiKey = keyRecord;
            req.user = { id: keyRecord.user_id };
            next();
        };
    }
}</code></pre>
                    </div>

                    <div class="validation">
                        <h4>‚úÖ Validation</h4>
                        <ul>
                            <li>Test API key validation with valid/invalid keys</li>
                            <li>Verify expired keys are rejected</li>
                            <li>Check revoked keys cannot be used</li>
                            <li>Validate scope-based access control</li>
                        </ul>
                    </div>

                    <div class="best-practices">
                        <h4>üìã Best Practices</h4>
                        <ul>
                            <li>Use cryptographically secure random generation</li>
                            <li>Store hashed versions, never plaintext</li>
                            <li>Implement key rotation policies</li>
                            <li>Add metadata (creation time, last used, scope)</li>
                            <li>Use prefixes for key identification</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Additional Authentication Controls Summary -->
            <div class="control-summary">
                <h4>Additional Authentication Controls (1.5-1.12):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>1.5 Certificate-Based Authentication:</strong> Mutual TLS (mTLS) for service-to-service communication
                    </div>
                    <div class="summary-item">
                        <strong>1.6 Brute Force Protection:</strong> Account lockout and progressive delays for failed attempts
                    </div>
                    <div class="summary-item">
                        <strong>1.7 Token Blacklisting & Revocation:</strong> Real-time token revocation system
                    </div>
                    <div class="summary-item">
                        <strong>1.8 Secure Credential Storage:</strong> Hardware security modules and encrypted storage
                    </div>
                    <div class="summary-item">
                        <strong>1.9 Cross-Domain Authentication:</strong> CORS and domain validation policies
                    </div>
                    <div class="summary-item">
                        <strong>1.10 Authentication Bypass Detection:</strong> Monitoring for bypass attempts
                    </div>
                    <div class="summary-item">
                        <strong>1.11 Authentication Event Logging:</strong> Comprehensive audit trail
                    </div>
                    <div class="summary-item">
                        <strong>1.12 Device Fingerprinting:</strong> Device-based authentication enhancement
                    </div>
                </div>
            </div>
        </section>

        <!-- Authorization Section (10 Controls) -->
        <section id="authorization" class="control-section">
            <h2>2. Authorization (10 Controls)</h2>
            <p class="section-intro">Authorization controls ensure that authenticated users can only access resources and perform actions they are explicitly permitted to. These controls implement fine-grained access control policies.</p>

            <!-- Control 2.1 -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">2.1 Role-Based Access Control (RBAC)</h3>
                    <div class="control-tags">
                        <span class="tag priority-critical">Critical</span>
                        <span class="tag difficulty-medium">Medium</span>
                    </div>
                </div>
                
                <div class="control-content">
                    <p class="control-description">Implement comprehensive role-based access control with hierarchical roles and permission inheritance.</p>
                    
                    <div class="implementation">
                        <h4>üîß Implementation</h4>
                        <pre><code>// RBAC System Implementation
class RBACManager {
    constructor(database) {
        this.db = database;
    }

    // Define role hierarchy and permissions
    async initializeRoles() {
        const roles = [
            {
                name: 'admin',
                permissions: ['*'], // All permissions
                inherits: []
            },
            {
                name: 'manager',
                permissions: ['read:all', 'write:own', 'delete:own'],
                inherits: ['user']
            },
            {
                name: 'user',
                permissions: ['read:own', 'write:own'],
                inherits: []
            },
            {
                name: 'viewer',
                permissions: ['read:own'],
                inherits: []
            }
        ];

        for (const role of roles) {
            await this.db.roles.upsert({ name: role.name }, role);
        }
    }

    // Check if user has specific permission
    async hasPermission(userId, permission, resource = null) {
        const userPermissions = await this.getUserPermissions(userId);
        
        // Check for wildcard permission
        if (userPermissions.includes('*')) return true;
        
        // Check for exact permission match
        if (userPermissions.includes(permission)) return true;
        
        // Check for resource-specific permissions
        if (resource) {
            const resourcePermission = `${permission}:${resource}`;
            if (userPermissions.includes(resourcePermission)) return true;
        }

        return false;
    }

    // Middleware for route protection
    requirePermission(permission) {
        return async (req, res, next) => {
            const userId = req.user?.id;
            if (!userId) {
                return res.status(401).json({ error: 'Authentication required' });
            }

            const hasAccess = await this.hasPermission(userId, permission);
            if (!hasAccess) {
                return res.status(403).json({ 
                    error: 'Insufficient permissions',
                    required: permission 
                });
            }

            next();
        };
    }
}</code></pre>
                    </div>

                    <div class="validation">
                        <h4>‚úÖ Validation</h4>
                        <ul>
                            <li>Test permission inheritance works correctly</li>
                            <li>Verify users cannot access unauthorized resources</li>
                            <li>Check role assignment and revocation</li>
                            <li>Test circular inheritance detection</li>
                        </ul>
                    </div>

                    <div class="best-practices">
                        <h4>üìã Best Practices</h4>
                        <ul>
                            <li>Follow principle of least privilege</li>
                            <li>Use descriptive permission names</li>
                            <li>Implement role hierarchies carefully</li>
                            <li>Regular access reviews and cleanup</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Control 2.2 -->
            <div class="control-card">
                <div class="control-header">
                    <h3 class="control-title">2.2 Attribute-Based Access Control (ABAC)</h3>
                    <div class="control-tags">
                        <span class="tag priority-high">High</span>
                        <span class="tag difficulty-high">High</span>
                    </div>
                </div>
                
                <div class="control-content">
                    <p class="control-description">Implement fine-grained attribute-based access control using policies that evaluate user, resource, and environmental attributes.</p>
                    
                    <div class="implementation">
                        <h4>üîß Implementation</h4>
                        <pre><code>// ABAC Policy Engine
class ABACEngine {
    constructor() {
        this.policies = new Map();
    }

    // Define ABAC policy
    addPolicy(name, policy) {
        this.policies.set(name, {
            ...policy,
            evaluate: this.compilePolicy(policy.rules)
        });
    }

    // Evaluate access request
    async authorize(context) {
        const results = [];
        
        for (const [name, policy] of this.policies) {
            const result = {
                policy: name,
                effect: policy.effect,
                decision: policy.evaluate(context)
            };
            results.push(result);
        }

        // Policy combination logic
        return this.combineDecisions(results);
    }

    // Combine policy decisions
    combineDecisions(results) {
        // Deny overrides - any explicit deny blocks access
        const denyResults = results.filter(r => r.effect === 'deny' && r.decision);
        if (denyResults.length > 0) {
            return { decision: 'deny', reason: 'Explicit deny policy matched' };
        }

        // Permit if any allow policy matches
        const permitResults = results.filter(r => r.effect === 'allow' && r.decision);
        if (permitResults.length > 0) {
            return { decision: 'allow', reason: 'Allow policy matched' };
        }

        return { decision: 'deny', reason: 'No matching allow policy' };
    }
}</code></pre>
                    </div>
                </div>
            </div>

            <!-- Additional Authorization Controls Summary -->
            <div class="control-summary">
                <h4>Additional Authorization Controls (2.3-2.10):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>2.3 API Scope Validation:</strong> OAuth scope validation and enforcement
                    </div>
                    <div class="summary-item">
                        <strong>2.4 Cross-Tenant Authorization:</strong> Strict tenant isolation and data access control
                    </div>
                    <div class="summary-item">
                        <strong>2.5 Dynamic Permission Evaluation:</strong> Context-aware permission decisions
                    </div>
                    <div class="summary-item">
                        <strong>2.6 Time-Based Access Control:</strong> Temporal access restrictions
                    </div>
                    <div class="summary-item">
                        <strong>2.7 Location-Based Access Control:</strong> Geographic access restrictions
                    </div>
                    <div class="summary-item">
                        <strong>2.8 Permission Inheritance & Delegation:</strong> Advanced permission models
                    </div>
                    <div class="summary-item">
                        <strong>2.9 Authorization Decision Logging:</strong> Audit trail for access decisions
                    </div>
                    <div class="summary-item">
                        <strong>2.10 Authorization Bypass Detection:</strong> Monitoring for bypass attempts
                    </div>
                </div>
            </div>
        </section>

        <!-- Input Validation Section (14 Controls) -->
        <section id="input-validation" class="control-section">
            <h2>3. Input Validation (14 Controls)</h2>
            <p class="section-intro">Comprehensive validation and sanitization of all API inputs to prevent injection attacks and data corruption.</p>

            <!-- Control 3.1 -->
            <div class="control-card">
                <h3>3.1 SQL Injection Prevention</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-medium">Medium</span>
                </div>
                <p><strong>Requirement:</strong> Use parameterized queries and prepared statements to prevent SQL injection attacks.</p>
                <div class="implementation">
                    <h4>üîß Implementation</h4>
                    <pre><code>// BAD - Vulnerable to SQL injection
const query = `SELECT * FROM users WHERE id = ${userId}`;

// GOOD - Parameterized query
const getUserById = async (userId) => {
    const query = 'SELECT * FROM users WHERE id = $1';
    const result = await pool.query(query, [userId]);
    return result.rows[0];
};

// GOOD - Using ORM (Sequelize example)
const user = await User.findOne({
    where: {
        id: userId,
        status: 'active'
    }
});

// GOOD - Using query builder (Knex.js)
const users = await knex('users')
    .where('email', email)
    .andWhere('status', 'active')
    .select('id', 'name', 'email');</code></pre>
                </div>
                <div class="validation">
                    <h4>‚úÖ Validation</h4>
                    <ul>
                        <li>Test with malicious SQL payloads</li>
                        <li>Verify all dynamic queries use parameters</li>
                        <li>Check stored procedures for dynamic SQL</li>
                        <li>Audit database logs for suspicious queries</li>
                    </ul>
                </div>
            </div>

            <!-- Control 3.2 -->
            <div class="control-card">
                <h3>3.2 NoSQL Injection Prevention</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High</span>
                    <span class="tag difficulty-medium">Medium</span>
                </div>
                <p><strong>Requirement:</strong> Sanitize inputs and use safe query methods for NoSQL databases like MongoDB.</p>
                <div class="implementation">
                    <h4>üîß Implementation</h4>
                    <pre><code>const Joi = require('joi');
const mongoSanitize = require('express-mongo-sanitize');

app.use(mongoSanitize()); // Removes $ and . from req.body

const loginSchema = Joi.object({
    username: Joi.string().alphanum().min(3).max(30).required(),
    password: Joi.string().min(8).required()
});

app.post('/api/login', async (req, res) => {
    const { error, value } = loginSchema.validate(req.body);
    if (error) {
        return res.status(400).json({ error: error.details[0].message });
    }
    
    const { username, password } = value;
    const user = await User.findOne({
        username: { $eq: username }, // Explicit operator
        status: 'active'
    });
    
    if (user && await bcrypt.compare(password, user.hashedPassword)) {
        // Login successful
    }
});</code></pre>
                </div>
            </div>

            <!-- Additional Input Validation Controls Summary -->
            <div class="control-summary">
                <h4>Additional Input Validation Controls (3.3-3.14):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>3.3 XSS Prevention:</strong> Output encoding and Content Security Policy
                    </div>
                    <div class="summary-item">
                        <strong>3.4 Request Size Limiting:</strong> Payload size restrictions and DoS prevention
                    </div>
                    <div class="summary-item">
                        <strong>3.5 JSON Schema Validation:</strong> Structural validation with Ajv
                    </div>
                    <div class="summary-item">
                        <strong>3.6 XML External Entity (XXE) Prevention:</strong> Secure XML parsing
                    </div>
                    <div class="summary-item">
                        <strong>3.7 File Type Validation:</strong> Magic byte verification and virus scanning
                    </div>
                    <div class="summary-item">
                        <strong>3.8 Parameter Pollution Prevention:</strong> Duplicate parameter handling
                    </div>
                    <div class="summary-item">
                        <strong>3.9 Content-Type Validation:</strong> MIME type verification
                    </div>
                    <div class="summary-item">
                        <strong>3.10 Path Traversal Prevention:</strong> Directory traversal protection
                    </div>
                    <div class="summary-item">
                        <strong>3.11 Command Injection Prevention:</strong> Safe system command execution
                    </div>
                    <div class="summary-item">
                        <strong>3.12 LDAP Injection Prevention:</strong> LDAP query sanitization
                    </div>
                    <div class="summary-item">
                        <strong>3.13 Email Header Injection:</strong> Email security validation
                    </div>
                    <div class="summary-item">
                        <strong>3.14 Regex DoS Prevention:</strong> Regular expression complexity limits
                    </div>
                </div>
            </div>
        </section>

        <!-- Rate Limiting Section (8 Controls) -->
        <section id="rate-limiting" class="control-section">
            <h2>4. Rate Limiting (8 Controls)</h2>
            <p class="section-intro">Implement traffic throttling and abuse prevention mechanisms to protect against DoS attacks and resource exhaustion.</p>

            <!-- Control 4.1 -->
            <div class="control-card">
                <h3>4.1 Token Bucket Rate Limiting</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High</span>
                    <span class="tag difficulty-medium">Medium</span>
                </div>
                <p><strong>Requirement:</strong> Implement token bucket algorithm for smooth rate limiting with burst capacity.</p>
                <div class="implementation">
                    <h4>üîß Implementation</h4>
                    <pre><code>class TokenBucketRateLimit {
    constructor(options) {
        this.capacity = options.capacity; // Maximum tokens
        this.refillRate = options.refillRate; // Tokens per second
        this.keyPrefix = options.keyPrefix || 'rate_limit:';
        this.redis = redis;
    }

    async checkRateLimit(identifier) {
        const key = this.keyPrefix + identifier;
        const now = Date.now();
        
        // Lua script for atomic operation
        const luaScript = `
            local key = KEYS[1]
            local capacity = tonumber(ARGV[1])
            local refillRate = tonumber(ARGV[2])
            local now = tonumber(ARGV[3])
            
            local bucket = redis.call('HMGET', key, 'tokens', 'lastRefill')
            local tokens = tonumber(bucket[1]) or capacity
            local lastRefill = tonumber(bucket[2]) or now
            
            -- Calculate tokens to add
            local timePassed = (now - lastRefill) / 1000
            local tokensToAdd = math.floor(timePassed * refillRate)
            tokens = math.min(capacity, tokens + tokensToAdd)
            
            if tokens >= 1 then
                tokens = tokens - 1
                redis.call('HMSET', key, 'tokens', tokens, 'lastRefill', now)
                redis.call('EXPIRE', key, 3600)
                return {1, tokens}
            else
                redis.call('HMSET', key, 'tokens', tokens, 'lastRefill', now)
                redis.call('EXPIRE', key, 3600)
                return {0, tokens}
            end
        `;
        
        const result = await this.redis.eval(
            luaScript, 1, key, 
            this.capacity, this.refillRate, now
        );
        
        return {
            allowed: result[0] === 1,
            tokensRemaining: result[1]
        };
    }
}</code></pre>
                </div>
            </div>

            <!-- Additional Rate Limiting Controls Summary -->
            <div class="control-summary">
                <h4>Additional Rate Limiting Controls (4.2-4.8):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>4.2 Sliding Window Rate Limiting:</strong> Precise rate limiting without boundary effects
                    </div>
                    <div class="summary-item">
                        <strong>4.3 User-Based Rate Limiting:</strong> Tiered limits based on subscription levels
                    </div>
                    <div class="summary-item">
                        <strong>4.4 IP-Based Rate Limiting:</strong> Network-level traffic control with CDN support
                    </div>
                    <div class="summary-item">
                        <strong>4.5 Geographic Rate Limiting:</strong> Regional traffic pattern management
                    </div>
                    <div class="summary-item">
                        <strong>4.6 Adaptive Rate Limiting:</strong> Dynamic limits based on system load
                    </div>
                    <div class="summary-item">
                        <strong>4.7 Circuit Breaker Pattern:</strong> Cascading failure prevention
                    </div>
                    <div class="summary-item">
                        <strong>4.8 DDoS Attack Detection:</strong> Real-time attack detection and mitigation
                    </div>
                </div>
            </div>
        </section>

        <!-- Logging & Monitoring Section (12 Controls) -->
        <section id="logging-monitoring" class="control-section">
            <h2>5. Logging & Monitoring (12 Controls)</h2>
            <p class="section-intro">Comprehensive logging and monitoring for security events, performance tracking, and incident response.</p>

            <!-- Control 5.1 -->
            <div class="control-card">
                <h3>5.1 Security Event Logging</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-medium">Medium</span>
                </div>
                <p><strong>Requirement:</strong> Log all security-relevant events including authentication, authorization failures, and suspicious activities.</p>
                <div class="implementation">
                    <h4>üîß Implementation</h4>
                    <pre><code>const winston = require('winston');
const { ElasticsearchTransport } = require('winston-elasticsearch');

// Security logger configuration
const securityLogger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.json()
    ),
    transports: [
        new winston.transports.File({ filename: 'logs/security.log' }),
        new ElasticsearchTransport({
            level: 'info',
            client: elasticClient,
            index: 'api-security-logs'
        })
    ]
});

// Security event types
const SecurityEvents = {
    AUTH_SUCCESS: 'auth_success',
    AUTH_FAILURE: 'auth_failure',
    AUTHORIZATION_FAILURE: 'authorization_failure',
    RATE_LIMIT_EXCEEDED: 'rate_limit_exceeded',
    SUSPICIOUS_PAYLOAD: 'suspicious_payload'
};</code></pre>
                </div>
            </div>

            <!-- Additional Logging & Monitoring Controls Summary -->
            <div class="control-summary">
                <h4>Additional Logging & Monitoring Controls (5.2-5.12):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>5.2 API Performance Monitoring:</strong> Response time and throughput metrics
                    </div>
                    <div class="summary-item">
                        <strong>5.3 Real-time Anomaly Detection:</strong> ML-based suspicious pattern detection
                    </div>
                    <div class="summary-item">
                        <strong>5.4 SIEM Integration:</strong> Security Information and Event Management
                    </div>
                    <div class="summary-item">
                        <strong>5.5 API Usage Analytics:</strong> Usage patterns and business intelligence
                    </div>
                    <div class="summary-item">
                        <strong>5.6 Error Rate Alerting:</strong> Automated error threshold monitoring
                    </div>
                    <div class="summary-item">
                        <strong>5.7 Data Access Logging:</strong> Comprehensive data audit trails
                    </div>
                    <div class="summary-item">
                        <strong>5.8 Audit Trail Maintenance:</strong> Immutable audit record keeping
                    </div>
                    <div class="summary-item">
                        <strong>5.9 Log Integrity Protection:</strong> Cryptographic log protection
                    </div>
                    <div class="summary-item">
                        <strong>5.10 Performance Alerting:</strong> System performance monitoring
                    </div>
                    <div class="summary-item">
                        <strong>5.11 Compliance Reporting:</strong> Automated compliance documentation
                    </div>
                    <div class="summary-item">
                        <strong>5.12 Incident Response Integration:</strong> Automated incident workflows
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Protection Section (9 Controls) -->
        <section id="data-protection" class="control-section">
            <h2>6. Data Protection (9 Controls)</h2>
            <p class="section-intro">Protect sensitive data through encryption, masking, and secure transmission protocols.</p>

            <!-- Control 6.1 -->
            <div class="control-card">
                <h3>6.1 End-to-End Encryption</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-high">High</span>
                </div>
                <p><strong>Requirement:</strong> Implement encryption for data in transit and at rest using industry-standard algorithms.</p>
                <div class="implementation">
                    <h4>üîß Implementation</h4>
                    <pre><code>const crypto = require('crypto');

// Data encryption for storage
class DataEncryption {
    constructor() {
        this.algorithm = 'aes-256-gcm';
        this.keySize = 32;
        this.ivSize = 16;
        this.tagSize = 16;
        this.key = this.getEncryptionKey();
    }

    encrypt(data) {
        const iv = crypto.randomBytes(this.ivSize);
        const cipher = crypto.createCipher(this.algorithm, this.key, iv);
        
        let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex');
        encrypted += cipher.final('hex');
        
        const tag = cipher.getAuthTag();
        
        return {
            encrypted,
            iv: iv.toString('hex'),
            tag: tag.toString('hex')
        };
    }

    decrypt(encryptedData) {
        const { encrypted, iv, tag } = encryptedData;
        const decipher = crypto.createDecipher(
            this.algorithm, 
            this.key, 
            Buffer.from(iv, 'hex')
        );
        
        decipher.setAuthTag(Buffer.from(tag, 'hex'));
        
        let decrypted = decipher.update(encrypted, 'hex', 'utf8');
        decrypted += decipher.final('utf8');
        
        return JSON.parse(decrypted);
    }
}</code></pre>
                </div>
            </div>

            <!-- Additional Data Protection Controls Summary -->
            <div class="control-summary">
                <h4>Additional Data Protection Controls (6.2-6.9):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>6.2 PII Data Masking:</strong> Context-aware personal data protection
                    </div>
                    <div class="summary-item">
                        <strong>6.3 Data Loss Prevention (DLP):</strong> Automated data exfiltration prevention
                    </div>
                    <div class="summary-item">
                        <strong>6.4 Secure Key Management:</strong> Hardware security modules and key rotation
                    </div>
                    <div class="summary-item">
                        <strong>6.5 Data Classification:</strong> Automated data sensitivity labeling
                    </div>
                    <div class="summary-item">
                        <strong>6.6 Backup Encryption:</strong> Secure backup and archive protection
                    </div>
                    <div class="summary-item">
                        <strong>6.7 Data Retention Policies:</strong> Lifecycle management and deletion
                    </div>
                    <div class="summary-item">
                        <strong>6.8 Secure Data Deletion:</strong> Cryptographic erasure techniques
                    </div>
                    <div class="summary-item">
                        <strong>6.9 Cross-Border Data Protection:</strong> International compliance management
                    </div>
                </div>
            </div>
        </section>

        <!-- API Gateway Security Section (5 Controls) -->
        <section id="api-gateway" class="control-section">
            <h2>7. API Gateway Security (5 Controls)</h2>
            <p class="section-intro">Centralized security policy enforcement through API gateway configuration and hardening.</p>

            <!-- Control 7.1 -->
            <div class="control-card">
                <h3>7.1 Gateway Authentication & Authorization</h3>
                <div class="control-tags">
                    <span class="tag priority-critical">Critical</span>
                    <span class="tag difficulty-medium">Medium</span>
                </div>
                <p><strong>Requirement:</strong> Configure API gateway for centralized authentication and authorization policy enforcement.</p>
                <div class="implementation">
                    <h4>üîß Implementation (Kong Gateway Example)</h4>
                    <pre><code># Kong Gateway Configuration

# Enable JWT Plugin
curl -X POST http://kong:8001/plugins \
  --data "name=jwt" \
  --data "config.secret_is_base64=false" \
  --data "config.claims_to_verify=exp,iat"

# Enable Rate Limiting
curl -X POST http://kong:8001/plugins \
  --data "name=rate-limiting" \
  --data "config.minute=100" \
  --data "config.hour=1000" \
  --data "config.policy=redis" \
  --data "config.redis_host=redis.example.com"

# Configure Service and Route
curl -X POST http://kong:8001/services \
  --data "name=api-service" \
  --data "url=http://api.internal:3000"

curl -X POST http://kong:8001/services/api-service/routes \
  --data "paths[]=/api" \
  --data "methods[]=GET" \
  --data "methods[]=POST"</code></pre>
                </div>
            </div>

            <!-- Additional API Gateway Controls Summary -->
            <div class="control-summary">
                <h4>Additional API Gateway Controls (7.2-7.5):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>7.2 Request/Response Transformation:</strong> Security header injection and sanitization
                    </div>
                    <div class="summary-item">
                        <strong>7.3 API Versioning Management:</strong> Deprecation policies and migration support
                    </div>
                    <div class="summary-item">
                        <strong>7.4 Load Balancing & Health Checks:</strong> High availability and circuit breakers
                    </div>
                    <div class="summary-item">
                        <strong>7.5 Gateway Monitoring & Analytics:</strong> Centralized API performance monitoring
                    </div>
                </div>
            </div>
        </section>

        <!-- GraphQL Security Section (4 Controls) -->
        <section id="graphql-security" class="control-section">
            <h2>8. GraphQL Security (4 Controls)</h2>
            <p class="section-intro">Specialized security controls for GraphQL APIs including query complexity analysis and depth limiting.</p>

            <!-- Control 8.1 -->
            <div class="control-card">
                <h3>8.1 Query Complexity Analysis</h3>
                <div class="control-tags">
                    <span class="tag priority-high">High</span>
                    <span class="tag difficulty-high">High</span>
                </div>
                <p><strong>Requirement:</strong> Analyze and limit GraphQL query complexity to prevent resource exhaustion attacks.</p>
                <div class="implementation">
                    <h4>üîß Implementation</h4>
                    <pre><code>const { GraphQLServer } = require('graphql-yoga');
const costAnalysis = require('graphql-cost-analysis');
const depthLimit = require('graphql-depth-limit');

// Query complexity analysis
const complexityLimitRule = costAnalysis({
    maximumCost: 1000,
    defaultCost: 1,
    scalarCost: 1,
    objectCost: 5,
    listFactor: 10,
    createError: (max, actual) => {
        throw new Error(
            `Query cost ${actual} exceeds maximum cost ${max}`
        );
    }
});

const server = new GraphQLServer({
    typeDefs,
    resolvers,
    validationRules: [
        complexityLimitRule,
        depthLimit(10)
    ],
    context: ({ request }) => ({
        req: request,
        user: request.user
    })
});</code></pre>
                </div>
            </div>

            <!-- Additional GraphQL Security Controls Summary -->
            <div class="control-summary">
                <h4>Additional GraphQL Security Controls (8.2-8.4):</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>8.2 Query Depth Limiting:</strong> Nested query depth restrictions
                    </div>
                    <div class="summary-item">
                        <strong>8.3 Introspection Control:</strong> Schema visibility and access control
                    </div>
                    <div class="summary-item">
                        <strong>8.4 Field-Level Authorization:</strong> Fine-grained field access permissions
                    </div>
                </div>
            </div>
        </section>

        <!-- Guide Footer -->
        <section class="guide-footer">
            <h3>Continue Your Security Journey</h3>
            <p>Explore related security guides and deepen your cybersecurity knowledge</p>
            <div class="footer-nav">
                <a href="iam.html" class="btn btn-outline">Identity & Access Management ‚Üí</a>
                <a href="cloud-security.html" class="btn btn-outline">Cloud Security ‚Üí</a>
                <a href="../topics.html" class="btn btn-primary">View All Topics</a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>üõ°Ô∏è Iron Codex</h3>
                    <p>Practical cybersecurity guidance for security professionals.</p>
                </div>
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="../topics.html">All Topics</a></li>
                        <li><a href="../guides.html">Deep Dive Guides</a></li>
                        <li><a href="../tools.html">Security Tools</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Community</h4>
                    <ul>
                        <li><a href="https://github.com/iron-codex">GitHub</a></li>
                        <li><a href="mailto:contact@iron-codex.com">Contact</a></li>
                        <li><a href="../about.html">About</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Iron Codex. Open source cybersecurity education.</p>
            </div>
        </div>
    </footer>

    <script src="../assets/js/main.js"></script>
</body>
</html>